<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Quiz</title>
<style>
    body {
        font-family: Arial, sans-serif;
    }
    .quiz-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    .question {
        margin-bottom: 15px;
    }
    .options label {
        display: block;
        margin-bottom: 10px;
    }
    button {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .question input[type=text]{
        height: 3vh;
        width: 100%;
        margin-bottom: 15px;
    }
    .question select{
        height: 3vh;
        width: 100%;
    }
    .custom-file-upload {
    width: 100%;
    display: inline-block;
    padding: 6px 3px;
    text-align: center;
    cursor: pointer;
    border: 1px dashed #000;
    border-radius: 4px;
    margin-bottom: 15px;
}

.custom-file-upload input[type="file"] {
    display: none;
}

.custom-file-upload span {
    margin-right: 5px;
}
</style>
</head>
<body>
    <div id="loginSignupContainer">
        <h2>Login/Signup</h2>
        <form id="loginForm">
            <input type="email" id="loginUsername" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button type="button" onclick="login()">Login</button>
        </form>
        <p>Don't have an account? <a href="#" onclick="showSignupForm()">Signup</a></p>
    </div>

    <div id="signupContainer" style="display: none;">
        <h2>Signup</h2>
        <form id="signupForm">
            <input type="email" id="signupUsername" placeholder="Email" required>
            <input type="password" id="signupPassword" placeholder="Password" required>
            <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
            <button type="button" onclick="signup()">Signup</button>
        </form>
    </div>
    <div id="mainContent" style="display: none;">
    <header>
        <!-- Inside the <header> tag -->
            <div id="user-info">
                <span id="username-info"></span>
                <div id="subject-buttons"></div> <!-- Display subject buttons here -->
            </div>

    </header>
<center>
<button type="button" onclick="addQuestion()">Add Question</button>

<div id="submittedQuiz" style="display: none;">
    <h2>Submitted Quiz</h2>
    <div id="submittedQuizContent"></div>
</div>
</center>
<div class="quiz-container" id="quiz-container">
    <h2>Dynamic Quiz</h2>
    <form id="quizForm" action="/submit" method="post" enctype="multipart/form-data">
        <!-- Dynamic quiz question fields -->
        <div id="quizQuestions">
            <!-- Initial question field -->
            <div class="question">
                
            </div>
        </div>
        <button type="button" onclick="submitQuiz()">Submit</button>
        <button type="button" onclick="addQuestion()">Add Question</button>
    </form>
</div>
</div>


<script>



window.onload = function() {
    var isLoggedIn = localStorage.getItem("isLoggedIn");
    if (isLoggedIn === "true") {
        // If the user is logged in, show the main content
        showMainContent();
    }
    fetchQuizDataAndDisplay();
};

function fetchQuizDataAndDisplay() {
    fetch('https://api.github.com/repos/Sanaullah2005/check2/contents/quiz_data.json')
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Failed to fetch quiz data from GitHub');
        }
    })
    .then(data => {
        // Decode quiz data
        var quizData = JSON.parse(atob(data.content));
        console.log(quizData)

        // Display each quiz
        quizData.forEach((quiz, index) => {
            createQuizInterface(quiz, index + 1);
        });
    })
    .catch(error => {
        console.error('Error fetching quiz data:', error);
        // Optionally, handle the error or provide feedback to the user
    });
}

// Function to dynamically create the quiz interface
function createQuizInterface(quiz, quizNumber) {

    var submittedQuizContent = document.getElementById("submittedQuizContent");
    
    document.getElementById("submittedQuiz").style.display = "block";


    // Displaying submitted quiz content
    var questionDiv = document.createElement("div");
            questionDiv.innerHTML = `<p>${quizNumber}. ${quiz.question}</p>`;
            questionDiv.innerHTML += `<p>Subject: ${quiz.subject}</p>`; // Display subject
            // Displaying images if available
            if (quiz.imageName) {
            const imageElement = document.createElement('img');
            imageElement.src = `https://raw.githubusercontent.com/Sanaullah2005/check2/main/images/${quiz.imageName}`;
            imageElement.style.maxWidth = '100%';
            questionDiv.appendChild(imageElement);
            var br = document.createElement("br");
            questionDiv.appendChild(br);
        }
            // Displaying options
            var options = quiz.options;
            var correctOptionIndex = quiz.correctOptionIndex;
            options.forEach((option, optionIndex) => {
                var label = document.createElement("label");
                var radioButton = document.createElement("input");
                radioButton.type = "radio";
                radioButton.name = "q" + (quizNumber);
                var isCorrect = optionIndex === correctOptionIndex;
                radioButton.dataset.correct = isCorrect.toString();
                radioButton.addEventListener("click", function() {
                    if (isCorrect) {
                        label.style.color = "green";
                    } else {
                        label.style.color = "red";
                        var correctRadio = questionDiv.querySelector('input[type="radio"][data-correct="true"]');
                        if (correctRadio) {
                            correctRadio.parentElement.style.color = "green";
                        }
                    }
                });
                label.appendChild(radioButton);
                label.appendChild(document.createTextNode(option));
                questionDiv.appendChild(label);
            });
            var user = document.createElement("p")
            user.innerText = quiz.username
            questionDiv.appendChild(user)
            submittedQuizContent.appendChild(questionDiv);
    
}


function addQuestion() {
    var quizQuestions = document.getElementById("quizQuestions");
    var questionNumber = quizQuestions.children.length;

    var newQuestion = document.createElement("div");
    newQuestion.classList.add("question");

    newQuestion.innerHTML = `
    <label for="subject${questionNumber}">subject</label>
    <select name="subject[]" id="subject${questionNumber}">
        <option value="Physics">Physics</option>
        <option value="Chemistry">Chemistry</option>
        <option value="Botany">Botany</option>
        <option value="Zoology">Zoology</option>
    </select>
        <label for="question${questionNumber}">Question ${questionNumber}:</label>
        <input type="text" id="question${questionNumber}" name="question[]" placeholder="Enter your question">
        <label for="image${questionNumber}" class="custom-file-upload">
            <span class="image">Choose image (optional)</span>
            <input type="file" id="image${questionNumber}" name="image" accept="image/*" onchange="previewImage(event, ${questionNumber})">
        </label>
        <div id="imagePreview${questionNumber}" style="display: none;"></div>
        <input type="text" name="options[]" placeholder="Option 1" data-correct="false">
        <input type="text" name="options[]" placeholder="Option 2" data-correct="false">
        <input type="text" name="options[]" placeholder="Option 3" data-correct="false">
        <input type="text" name="options[]" placeholder="Option 4" data-correct="false">
        <label>Choose correct Option :- </label>
        <select name="correctOption">
            <option value="1">Option 1</option>
            <option value="2">Option 2</option>
            <option value="3">Option 3</option>
            <option value="4">Option 4</option>
        </select>
    `;

    quizQuestions.appendChild(newQuestion);
}

function previewImage(event, questionNumber) {
    var input = event.target;
    var preview = document.getElementById(`imagePreview${questionNumber}`);
    var file = input.files[0];

    if (file) {
        var reader = new FileReader();
        reader.onload = function() {
            var img = document.createElement("img");
            img.src = reader.result;
            img.style.maxWidth = "200px"; // Adjust the size as needed
            preview.innerHTML = "";
            preview.appendChild(img);
            preview.style.display = "block";
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = "";
        preview.style.display = "none";
    }
}

function submitQuiz() {
    
    var form = document.getElementById("quizForm");
    var formData = new FormData(form);

    
    // Convert form data to JSON for further processing
    var quizData = {};
    formData.forEach((value, key) => {
        if (!quizData.hasOwnProperty(key)) {
            quizData[key] = [];
        }
        quizData[key].push(value);
    });

    // Generate quiz content based on submitted data
    var submittedQuizContent = document.getElementById("submittedQuizContent");

    // Inside the submitQuiz() function
var quizContent = []; // Array to hold quiz content for JSON

var username = localStorage.getItem("username");

Object.keys(quizData).forEach((key, index) => {
    if (key === "question[]") {
        quizData[key].forEach((question, index) => {
            var questionData = {
                question: question,
                subject: formData.getAll('subject[]')[index], // Get selected subject for the question
                options: quizData["options[]"].slice(index * 4, (index + 1) * 4),
                correctOptionIndex: parseInt(quizData["correctOption"][index]) - 1 // Adjust for 0-based index
            };
            quizContent.push(questionData);

            // Displaying submitted quiz content
            var questionDiv = document.createElement("div");
            questionDiv.innerHTML = `<p>${index + 1}. ${question}</p>`;
            questionDiv.innerHTML += `<p>Subject: ${questionData.subject}</p>`; // Display subject
            // Displaying images if available
            var image = formData.getAll("image")[index];
            if (image && image.size > 0) {
                var imageElement = document.createElement("img");
                imageElement.src = URL.createObjectURL(image);
                imageElement.style.maxWidth = "100%";
                var br = document.createElement("br");
                questionDiv.appendChild(imageElement);
                questionDiv.appendChild(br);
            }
            // Displaying options
            var options = questionData.options;
            var correctOptionIndex = questionData.correctOptionIndex;
            options.forEach((option, optionIndex) => {
                var label = document.createElement("label");
                var radioButton = document.createElement("input");
                radioButton.type = "radio";
                radioButton.name = "q" + (index + 1);
                var isCorrect = optionIndex === correctOptionIndex;
                radioButton.dataset.correct = isCorrect.toString();
                radioButton.addEventListener("click", function() {
                    if (isCorrect) {
                        label.style.color = "green";
                    } else {
                        label.style.color = "red";
                        var correctRadio = questionDiv.querySelector('input[type="radio"][data-correct="true"]');
                        if (correctRadio) {
                            correctRadio.parentElement.style.color = "green";
                        }
                    }
                });
                label.appendChild(radioButton);
                label.appendChild(document.createTextNode(option));
                questionDiv.appendChild(label);
            });
            var user = document.createElement("p")
            user.innerText = username
            questionDiv.appendChild(user)
            submittedQuizContent.appendChild(questionDiv);
        });
    }
});
    document.getElementById("submittedQuiz").style.display = "block";

    // Convert form data to JSON for further processing
    var quizData = {};
    formData.forEach((value, key) => {
        if (!quizData.hasOwnProperty(key)) {
            quizData[key] = [];
        }
        quizData[key].push(value);
    });

    // Generate quiz content based on submitted data
    var quizContent = []; // Array to hold quiz content for JSON

    Object.keys(quizData).forEach(key => {
        if (key === "question[]") {
            quizData[key].forEach((question, index) => {
                var questionData = {
                    question: question,
                    options: quizData["options[]"].slice(index * 4, (index + 1) * 4),
                    correctOptionIndex: parseInt(quizData["correctOption"][index]) - 1, // Adjust for 0-based index
                    subject: formData.getAll('subject[]')[index], // Get selected subject for the question
                    uploadDate: new Date().toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' }), // Indian date format (only date)
                    username: localStorage.getItem("username") // Indian date format (only date)
                };

                // Fetch selected image name using the input element's ID
                var imageInput = document.getElementById(`image${index+1}`);
                var imageName = "";
                if (imageInput && imageInput.files.length > 0) {
                    imageName = imageInput.files[0].name;
                }

                // Append image name to question data
                questionData.imageName = imageName;

                quizContent.push(questionData);
            });
        }
    });

    // Fetch existing quiz data from GitHub
    fetch('https://api.github.com/repos/Sanaullah2005/check2/contents/quiz_data.json')
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to fetch existing quiz data from GitHub');
    })
    .then(existingData => {
        // Decode existing data content
        var existingContent = JSON.parse(atob(existingData.content));
        
        // Append new quiz content to existing content
        existingContent = existingContent.concat(quizContent);

        // Convert merged content to JSON
        var mergedContent = JSON.stringify(existingContent, null, 2);

        // Upload merged content back to GitHub
        return fetch('https://api.github.com/repos/Sanaullah2005/check2/contents/quiz_data.json', {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer 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',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: 'Append quiz data',
                content: btoa(mergedContent), // Encode content as base64
                sha: existingData.sha // SHA of the existing file
            })
        });
    })
    .then(response => {
        if (response.ok) {
            console.log('Quiz data appended successfully');
            // Optionally, provide feedback to the user
        } else {
            throw new Error('Failed to upload quiz data to GitHub');
        }
    })
    .catch(error => {
        console.error('Error appending quiz data:', error);
        // Optionally, provide feedback to the user
    });

    // Upload images to GitHub repository
    Object.keys(quizData).forEach(key => {
        if (key.startsWith("image")) {
            var image = quizData[key][0];
            var reader = new FileReader();
            reader.onload = function(event) {
                var imageData = event.target.result.split(',')[1]; // Extract base64 data
                fetch('https://api.github.com/repos/Sanaullah2005/check2/contents/images/' + image.name, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer 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',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Add image',
                        content: imageData
                    })
                })
                .then(response => {
                    if (response.ok) {
                        console.log('Image uploaded successfully:', image.name);
                        // Optionally, provide feedback to the user
                    } else {
                        throw new Error('Failed to upload image to GitHub');
                    }
                })
                .catch(error => {
                    console.error('Error uploading image:', error);
                    // Optionally, provide feedback to the user
                });
            };
            reader.readAsDataURL(image);
        }
    });
}

function showSignupForm() {
    // Hide login form and show signup form
    document.getElementById("loginSignupContainer").style.display = "none";
    document.getElementById("signupContainer").style.display = "block";
}



function login() {
    var username = document.getElementById("loginUsername").value;
    var password = document.getElementById("loginPassword").value;

    fetch('https://api.github.com/repos/Sanaullah2005/check2/contents/user.json')
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Failed to fetch user data from GitHub');
        }
    })
    .then(data => {
        // Decode user data
        var userData = JSON.parse(atob(data.content));

        // Check if the username and password match any user's credentials
        var user = userData.find(user => user.username === username && user.password === password);

        if (user) {
            // Login successful
            localStorage.setItem("isLoggedIn", "true"); // Set the user's login status to true
            localStorage.setItem("username", username); // Store the username in localStorage
            showMainContent();
        } else {
            // Login failed
            alert("Invalid username or password. Please try again.");
        }
    })
    .catch(error => {
        console.error('Error fetching user data:', error);
        // Optionally, handle the error or provide feedback to the user
    });
}

function showMainContent() {
    var username = localStorage.getItem("username");
    document.getElementById("loginSignupContainer").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    document.getElementById("username-info").innerText = username;
}


function signup() {
    // Perform signup functionality
    var username = document.getElementById("signupUsername").value;
    var password = document.getElementById("signupPassword").value;
    var confirmPassword = document.getElementById("confirmPassword").value;

    // Here you would typically send a request to your backend server to create a new user
    // For simplicity, let's assume successful signup if username, password, and confirmPassword are not empty and password matches confirmPassword
    if (username && password && confirmPassword && password === confirmPassword) {
        // Save user data (username and password) to GitHub repository
        var userData = {
            username: username,
            password: password
        };

        fetch('https://api.github.com/repos/Sanaullah2005/check2/contents/user.json')
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Failed to fetch user data from GitHub');
        })
        .then(existingData => {
            // Decode existing data content
            var existingContent = JSON.parse(atob(existingData.content));
            
            // Append new user data to existing content
            existingContent.push(userData);

            // Convert merged content to JSON
            var mergedContent = JSON.stringify(existingContent, null, 2);

            // Upload merged content back to GitHub
            return fetch('https://api.github.com/repos/Sanaullah2005/check2/contents/user.json', {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer 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',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'Append user data',
                    content: btoa(mergedContent), // Encode content as base64
                    sha: existingData.sha // SHA of the existing file
                })
            });
        })
        .then(response => {
            if (response.ok) {
                // Redirect to login section
                document.getElementById("signupContainer").style.display = "none";
                document.getElementById("loginSignupContainer").style.display = "block";
                alert("Signup successful. Please login to continue.");
            } else {
                throw new Error('Failed to upload user data to GitHub');
            }
        })
        .catch(error => {
            console.error('Error appending user data:', error);
            // Optionally, provide feedback to the user
        });

    } else {
        // Show error message or handle unsuccessful signup
        alert("Invalid input or passwords do not match. Please try again.");
    }
}

</script>

</body>
</html>
